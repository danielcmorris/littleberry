<div class="page-container">

    <crumbs links="vm.links"></crumbs>

    <!-- NOT LOGGED IN -->
    <div ng-if="!vm.permission.AddRequest">
        <div class="text-center" style="max-width:500px;margin:40px auto">
            <div class="card card-padded">
                <i class="fa fa-lock lock-icon"></i>
                <p class="text-lg text-secondary mb-md">
                    Sign in to your account to request a book. New to the library?
                    <a href="#" class="text-primary fw-600">Create an account</a>.
                </p>
            </div>
        </div>
        <login redirect="vm.redirect"></login>
    </div>

    <!-- ADD REQUEST MODE -->
    <form autocomplete="on" ng-if="vm.permission.AddRequest">
        <div ng-if="vm.mode=='add'" class="mt-md">
            <div class="card" style="max-width:700px">
                <div class="card-header">
                    <span class="card-title">
                        <i class="fa fa-bookmark-o icon-mr"></i>
                        Request: {{vm.book.Title}}
                    </span>
                </div>
                <div class="card-content">
                    <div ng-if="vm.permission.Requests" class="mb-md">
                        <div ng-hide="vm.showSearch" class="text-right">
                            <button class="btn btn-default btn-sm" ng-click="vm.showSearch=true">
                                <i class="fa fa-users icon-mr"></i> Book for someone else
                            </button>
                        </div>
                        <div ng-show="vm.showSearch" class="highlight-box mb-md">
                            <label class="block mb-sm text-sm">Search by email to book for another member:</label>
                            <div class="flex gap-sm items-center">
                                <input type="text" class="form-control flex-1" ng-model="vm.email" placeholder="member@email.com"
                                    autocomplete="shipping email" />
                                <button type="button" class="btn btn-primary btn-sm" ng-click="vm.LookupAccount('email',vm.email)">Search</button>
                                <button type="button" class="btn btn-default btn-sm" ng-click="vm.showSearch=false">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div ng-show="vm.showAddress && !vm.showSearch" class="address-card">
                        <div class="flex flex-wrap gap-lg">
                            <div class="flex-1 min-w-250">
                                <h4 class="font-display fw-600 m-0 mb-md text-primary">Contact</h4>
                                <div class="form-field">
                                    <label>First Name</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.FirstName" />
                                </div>
                                <div class="form-field">
                                    <label>Last Name</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.LastName" />
                                </div>
                                <div class="form-field">
                                    <label>Phone</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.Phone" />
                                </div>
                                <div class="form-field">
                                    <label>Email</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.Email" />
                                </div>
                                <div class="form-field">
                                    <label>Note</label>
                                    <textarea class="form-control" ng-model="vm.Note" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="flex-1 min-w-250">
                                <h4 class="font-display fw-600 m-0 mb-md text-primary">Address</h4>
                                <div class="form-field">
                                    <label>Street 1</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.Address1" />
                                </div>
                                <div class="form-field">
                                    <label>Street 2</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.Address2" />
                                </div>
                                <div class="form-field">
                                    <label>City</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.City" />
                                </div>
                                <div class="flex gap-md mb-md">
                                    <div class="flex-1">
                                        <label>State</label>
                                        <input type="text" class="form-control" ng-model="vm.Account.State" />
                                    </div>
                                    <div class="flex-1">
                                        <label>Zip</label>
                                        <input type="text" class="form-control" ng-model="vm.Account.Zip" />
                                    </div>
                                </div>
                                <div class="form-field">
                                    <label>Country</label>
                                    <input type="text" class="form-control" ng-model="vm.Account.Country" />
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-sm mt-lg">
                            <button type="button" class="btn btn-primary" ng-click="vm.AddRequestByAccount(vm.Account, vm.callNumber);">
                                <i class="fa fa-check icon-mr"></i> Submit Request
                            </button>
                            <button type="button" class="btn btn-default" ng-click="vm.showAddress=false;vm.email=''">Cancel</button>
                        </div>
                    </div>

                    <!-- CONFIRMATION -->
                    <div ng-if="vm.showConfirm==true" class="confirm-box">
                        <i class="fa fa-check-circle block text-primary" style="font-size:48px;margin-bottom:12px"></i>
                        <h4 class="font-display text-primary m-0 mb-sm">Request Submitted</h4>
                        <p class="text-secondary mb-md">Your request for <strong>{{vm.book.Title}}</strong> has been submitted.</p>
                        <button type="button" class="btn btn-primary" ng-click="vm.go('library/catalog')">
                            Return to Catalog
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- REQUEST LIST -->
    <div ng-show="vm.showList">
        <div class="flex justify-between items-center flex-wrap gap-md mb-lg">
            <h2 class="font-display fw-600 m-0">Open Requests</h2>
            <form class="form-inline">
                <input type="text" ng-model="vm.email" ng-if="vm.permission.Requests"
                    class="form-control" style="width:200px" placeholder="Search by email..." />
                <input type="text" ng-model="vm.callNumber" class="form-control" style="width:130px" placeholder="Call number..." />
            </form>
        </div>

        <div class="overflow-x-auto">
            <table class="table">
                <tr>
                    <th>Request #</th>
                    <th>Requested By</th>
                    <th>Call No.</th>
                    <th>Requested</th>
                    <th>Packed</th>
                    <th>Shipped</th>
                    <th>Due</th>
                    <th>Received</th>
                    <th>Reshelved</th>
                </tr>
                <tr ng-repeat="res in vm.requests | filter:{RequestByEmail:vm.email} | filter: {CallNumber: vm.callNumber}">
                    <td class="fw-600 text-primary">{{res.ReservationSubId}}</td>
                    <td>
                        <a ng-href="/#/library/accounts/{{res.AccountId}}">{{res.RequestByEmail}}</a>
                    </td>
                    <td>
                        <a ng-href="#/library/catalog/edit/{{res.Prefix}}/{{res.BookNumber}}" class="font-mono">
                            {{res.Prefix}}{{res.BookNumber}}
                        </a>
                    </td>
                    <td>{{res.RequestDate | date:'MM/dd/yyyy'}}</td>
                    <td>
                        <div class="input-group" ng-if="res.PackDate">
                            <input type="text" value="{{res.PackDate | date: 'shortDate'}}" readonly class="form-control form-control-compact" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-sm" ng-click="vm.UpdateRequest('Pack',res,false)">&times;</button>
                            </span>
                        </div>
                        <div ng-if="!res.PackDate">
                            <md-datepicker ng-change="vm.UpdateRequest('Pack',res,true,res.packDate)" ng-model="res.packDate"
                                md-placeholder="Set date" md-hide-icons="calendar"></md-datepicker>
                        </div>
                    </td>
                    <td>
                        <div class="input-group" ng-if="res.ShipDate">
                            <input type="text" value="{{res.ShipDate | date: 'shortDate'}}" readonly class="form-control form-control-compact" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-sm" ng-click="vm.UpdateRequest('Ship',res,false)">&times;</button>
                            </span>
                        </div>
                        <div ng-if="!res.ShipDate && res.PackDate">
                            <md-datepicker ng-change="vm.UpdateRequest('Ship',res,true,res.shipDate)" ng-model="res.shipDate"
                                md-placeholder="Set date" md-hide-icons="calendar"></md-datepicker>
                        </div>
                    </td>
                    <td>
                        <div class="input-group" ng-if="res.DueDate">
                            <input type="text" value="{{res.DueDate | date: 'shortDate'}}" readonly class="form-control form-control-compact" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-sm" ng-click="vm.UpdateRequest('Due',res,false)">&times;</button>
                            </span>
                        </div>
                        <div ng-if="!res.DueDate && res.ShipDate">
                            <md-datepicker ng-change="vm.UpdateRequest('Due',res,true,res.dueDate)" ng-model="res.dueDate"
                                md-placeholder="Set date" md-hide-icons="calendar"></md-datepicker>
                        </div>
                    </td>
                    <td>
                        <div class="input-group" ng-if="res.ReceivedDate">
                            <input type="text" value="{{res.ReceivedDate | date: 'shortDate'}}" readonly class="form-control form-control-compact" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-sm" ng-click="vm.UpdateRequest('Receive',res,false)">&times;</button>
                            </span>
                        </div>
                        <div ng-if="!res.ReceivedDate && res.DueDate">
                            <md-datepicker ng-change="vm.UpdateRequest('Receive',res,true,res.ReceivedDate)" ng-model="res.ReceivedDate"
                                md-placeholder="Set date" md-hide-icons="calendar"></md-datepicker>
                        </div>
                    </td>
                    <td>
                        <div class="input-group" ng-if="res.ReshelveDate">
                            <input type="text" value="{{res.ReshelveDate | date: 'shortDate'}}" readonly class="form-control form-control-compact" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default btn-sm" ng-click="vm.UpdateRequest('Shelve',res,false)">&times;</button>
                            </span>
                        </div>
                        <div ng-if="!res.ReshelveDate && res.ReceivedDate">
                            <md-datepicker ng-change="vm.UpdateRequest('Shelve',res,true,res.reshelveDate)" ng-model="res.reshelveDate"
                                md-placeholder="Set date" md-hide-icons="calendar"></md-datepicker>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

</div>
